{% extends "trading/_base.html" %}
{% load humanize %}

{% block title %}계좌 현황 - Trading Dashboard{% endblock %}

{% block content %}
<div class="card">
    <h2>계좌 종합 현황</h2>
    {% for detail in account_details %}
        <div class="account-summary" style="margin-bottom: 2em;">
            <h3>{{ detail.account.account_name }} ({{ detail.account.account_number }})</h3>
            {% if detail.error %}
                <p class="error">{{ detail.error }}</p>
            {% elif detail.balance_summary %}
                <table>
                    <tr>
                        <th>총 평가금액</th><td class="number">{{ detail.balance_summary.tot_evlu_amt|intcomma }} 원</td>
                        <th>예수금</th><td class="number">{{ detail.balance_summary.dnca_tot_amt|intcomma }} 원</td>
                    </tr>
                    <tr>
                        <th>총 평가손익률</th><td class="number {% if detail.balance_summary.tot_pftrt|floatformat > 0 %}pl-positive{% else %}pl-negative{% endif %}">{{ detail.balance_summary.tot_pftrt|floatformat:"2" }}%</td>
                        <th>총 평가손익</th><td class="number">{{ detail.balance_summary.tot_pfls_amt|intcomma }} 원</td>
                    </tr>
                </table>

                <h4 style="margin-top: 1.5em;">보유 종목 (요약)</h4>
                {% if detail.positions %}
                    <table>
                        <thead>
                            <tr>
                                <th>종목명</th>
                                <th class="number">보유수량</th>
                                <th class="number">평가금액</th>
                                <th class="number">수익률(%)</th>
                            </tr>
                        </thead>
                        <tbody id="positions-{{ detail.account.id }}">
                        {% for pos in detail.positions %}
                            <tr id="pos-{{ detail.account.id }}-{{ pos.symbol }}" data-avg-price="{{ pos.average_buy_price }}" data-quantity="{{ pos.quantity }}">
                                <td>{{ pos.stock_name }} ({{ pos.symbol }})</td>
                                <td class="number hldg_qty">{{ pos.quantity|intcomma }}</td>
                                <td class="number evlu_amt">{{ pos.evlu_amt|intcomma }}</td>
                                <td class="number evlu_pfls_rt {% if pos.evlu_pfls_rt > 0 %}pl-positive{% else %}pl-negative{% endif %}">{{ pos.evlu_pfls_rt|floatformat:"2" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>보유 종목이 없습니다.</p>
                {% endif %}
            {% endif %}
        </div>
        {% if not forloop.last %}<hr style="border: 0; border-top: 1px solid #eee; margin: 2em 0;">{% endif %}
    {% empty %}
        <p>활성화된 계좌가 없습니다. 관리자 페이지에서 계좌를 추가해주세요.</p>
    {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // This overrides the placeholder function in _base.html
    window.handlePriceUpdate = function(data) {
        const symbol = data.symbol;
        const newPrice = parseFloat(data.price);

        // Find all rows for this symbol (could be in multiple accounts)
        const rows = document.querySelectorAll(`tr[id$="-${symbol}"]`);

        rows.forEach(row => {
            const avgPrice = parseFloat(row.dataset.avgPrice);
            const quantity = parseInt(row.dataset.quantity);

            if (!avgPrice || !quantity) return;

            const evluAmtCell = row.querySelector('.evlu_amt');
            const pflsRtCell = row.querySelector('.evlu_pfls_rt');

            // Calculate new values
            const newEvluAmt = newPrice * quantity;
            const newPflsRt = avgPrice > 0 ? ((newPrice / avgPrice) - 1) * 100 : 0;

            // Update cell content
            evluAmtCell.innerText = newEvluAmt.toLocaleString();
            pflsRtCell.innerText = newPflsRt.toFixed(2);

            // Update cell style
            pflsRtCell.classList.remove('pl-positive', 'pl-negative');
            if (newPflsRt > 0) {
                pflsRtCell.classList.add('pl-positive');
            } else {
                pflsRtCell.classList.add('pl-negative');
            }

            // Optional: add a subtle flash effect to highlight the change
            row.style.transition = 'background-color 0.1s ease-in-out';
            row.style.backgroundColor = '#e8f4fd';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 500);
        });
    };

    // When the socket is ready, subscribe to all visible symbols
    const originalOnOpen = window.tradingSocket.onopen;
    window.tradingSocket.onopen = function(e) {
        if (originalOnOpen) {
            originalOnOpen(e);
        }

        const symbolsToSubscribe = new Set();
        document.querySelectorAll('tr[id^="pos-"]').forEach(row => {
            const symbol = row.id.split('-').pop();
            symbolsToSubscribe.add(symbol);
        });

        console.log("Subscribing to price updates for symbols:", ...symbolsToSubscribe);
        symbolsToSubscribe.forEach(symbol => {
            window.tradingSocket.send(JSON.stringify({'type': 'subscribe_stock', 'symbol': symbol}));
        });
    };

    // If socket is already open when this script runs, call it immediately
    if (window.tradingSocket && window.tradingSocket.readyState === WebSocket.OPEN) {
        window.tradingSocket.onopen();
    }
});
</script>
{% endblock %}
