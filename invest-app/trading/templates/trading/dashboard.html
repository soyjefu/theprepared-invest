<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        h1, h2 { color: #444; }
        .container { background-color: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { margin-bottom: 2em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.8em; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #eef; }
        .pl-positive { color: green; }
        .pl-negative { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trading Dashboard</h1>

        {% if all_accounts %}
        <div class="section">
            <form method="get" action="">
                <label for="account_id">Select Account:</label>
                <select name="account_id" id="account_id" onchange="this.form.submit()">
                    {% for acc in all_accounts %}
                        <option value="{{ acc.pk }}" {% if acc.pk == selected_account.pk %}selected{% endif %}>
                            {{ acc.account_name }} ({{ acc.account_number }})
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        {% endif %}

        <div class="section">
            <h2>Account Summary</h2>
            {% if selected_account %}
                <p><strong>Account:</strong> {{ selected_account.account_name }} ({{ selected_account.account_number }})</p>
                {% if balance %}
                    <table>
                        <tr>
                            <th>Total Assets</th>
                            <td>{{ balance.tot_evlu_amt|floatformat:0 }} KRW</td>
                        </tr>
                        <tr>
                            <th>Cash Balance</th>
                            <td>{{ balance.dnca_tot_amt|floatformat:0 }} KRW</td>
                        </tr>
                        <tr>
                            <th>Total Profit/Loss Rate</th>
                            <td class="{% if balance.tot_pftrt > 0 %}pl-positive{% else %}pl-negative{% endif %}">{{ balance.tot_pftrt|floatformat:2 }}%</td>
                        </tr>
                    </table>
                {% elif balance_error %}
                    <p style="color: red;">{{ balance_error }}</p>
                {% else %}
                    <p>Loading account balance...</p>
                {% endif %}
            {% else %}
                <p>No active trading account found. Please configure one in the admin panel.</p>
            {% endif %}
        </div>

        <div class="section">
            <h2>AI Strategy Settings</h2>
            {% if settings %}
                <p>
                    <strong>Short-Term Allocation:</strong> {{ settings.short_term_allocation }}%<br>
                    <strong>Mid-Term Allocation:</strong> {{ settings.mid_term_allocation }}%<br>
                    <strong>Long-Term Allocation:</strong> {{ settings.long_term_allocation }}%<br>
                    <em>Last Updated: {{ settings.updated_at|date:"Y-m-d H:i" }}</em>
                </p>
            {% else %}
                <p>Strategy settings have not been configured in the admin yet.</p>
            {% endif %}
        </div>

        <div class="section">
            <h2>Open Positions (Total P/L: <span class="{% if total_pl > 0 %}pl-positive{% else %}pl-negative{% endif %}">{{ total_pl|floatformat:2 }}</span>)</h2>
            {% if open_positions %}
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Quantity</th>
                            <th>Avg. Buy Price</th>
                            <th>Current Price</th>
                            <th>Market Value</th>
                            <th>P/L</th>
                            <th>P/L %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in open_positions %}
                            <tr>
                                <td>{{ item.position.stock_name }} ({{ item.position.symbol }})</td>
                                <td>{{ item.position.quantity }}</td>
                                <td>{{ item.position.average_buy_price|floatformat:2 }}</td>
                                <td>{{ item.current_price|floatformat:2 }}</td>
                                <td>{{ item.market_value|floatformat:2 }}</td>
                                <td class="{% if item.pl > 0 %}pl-positive{% else %}pl-negative{% endif %}">{{ item.pl|floatformat:2 }}</td>
                                <td class="{% if item.pl > 0 %}pl-positive{% else %}pl-negative{% endif %}">{{ item.pl_percent|floatformat:2 }}%</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No open positions for this account.</p>
            {% endif %}
        </div>

        <div class="section">
            <h2>Recent Trades</h2>
            {% if recent_trades %}
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in recent_trades %}
                            <tr>
                                <td>{{ trade.timestamp|date:"Y-m-d H:i:s" }}</td>
                                <td>{{ trade.symbol }}</td>
                                <td>{{ trade.get_trade_type_display }}</td>
                                <td>{{ trade.quantity }}</td>
                                <td>{{ trade.price|floatformat:2 }}</td>
                                <td>{{ trade.get_status_display }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No recent trades found.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>
