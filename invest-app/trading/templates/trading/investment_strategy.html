<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 기반 투자 전략 수립</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .header { background-color: #fff; padding: 1em 2em; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; color: #1a2c5b; }
        .container { padding: 2em; max-width: 900px; margin: 0 auto; }
        .card { background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 2em; }
        h2 { color: #1a2c5b; border-bottom: 2px solid #eef; padding-bottom: 0.5em; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 1em; }
        th, td { padding: 0.8em; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f7f7f7; font-weight: 600; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .hidden { display: none; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .form-group { margin-bottom: 1em; }
        label { font-weight: 600; display: block; margin-bottom: 0.5em; }
        select, input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
        .stock-row { cursor: pointer; }
        .stock-row:hover { background-color: #f5f5f5; }
        .selected-row { background-color: #e0eafc; }
    </style>
</head>
<body>
    {% load humanize %}
    <header class="header">
        <h1>AI 기반 투자 전략 수립</h1>
        <a href="{% url 'trading:dashboard' %}" style="text-decoration: none;">
            <button>대시보드로 돌아가기</button>
        </a>
    </header>

    <div class="container">
        <!-- Step 1: Stock Screening -->
        <div id="step-1-card" class="card">
            <h2>1차: 투자 적정 종목 선별</h2>
            <p>AI가 시장 상황을 분석하여 투자에 적합할 수 있는 종목을 선별합니다.</p>
            <button id="start-screening-btn">AI 분석으로 추천 종목 보기</button>
            <div id="screening-loader" class="hidden">
                <p>종목을 분석하고 있습니다... <span class="spinner"></span></p>
            </div>
            <div id="screening-results" class="hidden">
                <h3>분석 완료: 아래 목록에서 종목을 선택하세요.</h3>
                <table id="stock-list-table">
                    <thead>
                        <tr>
                            <th>종목명</th>
                            <th>종목코드</th>
                            <th>현재가</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Stock rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Step 2: Strategy Configuration -->
        <div id="step-2-card" class="card hidden">
            <h2>2차: 투자 전략 설정</h2>
            <p>선택된 종목: <strong id="selected-stock-name"></strong> (<span id="selected-stock-symbol"></span>)</p>
            <div class="form-group">
                <label for="investment-horizon">투자 타입 설정</label>
                <select id="investment-horizon">
                    <option value="SHORT">단기 투자 (1개월 이내)</option>
                    <option value="MID">중기 투자 (1~3개월)</option>
                    <option value="LONG">장기 투자 (3개월 이상)</option>
                </select>
            </div>
            <button id="get-strategy-btn">3차 분석 요청 (매수/매도 전략)</button>
        </div>

        <!-- Step 3: Final Analysis Result -->
        <div id="step-3-card" class="card hidden">
            <h2>3차: 최종 분석 결과</h2>
             <div id="strategy-loader" class="hidden">
                <p>최종 전략을 수립하고 있습니다... <span class="spinner"></span></p>
            </div>
            <div id="strategy-result">
                <!-- Strategy details will be inserted here -->
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Elements ---
        const startScreeningBtn = document.getElementById('start-screening-btn');
        const screeningLoader = document.getElementById('screening-loader');
        const screeningResults = document.getElementById('screening-results');
        const stockListTableBody = document.querySelector('#stock-list-table tbody');

        const step2Card = document.getElementById('step-2-card');
        const selectedStockName = document.getElementById('selected-stock-name');
        const selectedStockSymbol = document.getElementById('selected-stock-symbol');
        const getStrategyBtn = document.getElementById('get-strategy-btn');

        const step3Card = document.getElementById('step-3-card');
        const strategyLoader = document.getElementById('strategy-loader');
        const strategyResult = document.getElementById('strategy-result');

        let selectedSymbol = null;
        let selectedName = null;

        // --- CSRF Token for Django ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // --- Event Listeners ---
        startScreeningBtn.addEventListener('click', function() {
            screeningLoader.classList.remove('hidden');
            startScreeningBtn.disabled = true;
            screeningResults.classList.add('hidden');
            stockListTableBody.innerHTML = '';

            fetch(`{% url 'trading:investment_strategy' %}?action=screen_stocks`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    renderStockList(data.stocks);
                    screeningResults.classList.remove('hidden');
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error during stock screening:', error);
                alert('종목 분석 중 오류가 발생했습니다.');
            })
            .finally(() => {
                screeningLoader.classList.add('hidden');
                startScreeningBtn.disabled = false;
            });
        });

        stockListTableBody.addEventListener('click', function(e) {
            const row = e.target.closest('.stock-row');
            if (!row) return;

            document.querySelectorAll('.stock-row').forEach(r => r.classList.remove('selected-row'));
            row.classList.add('selected-row');

            selectedSymbol = row.dataset.symbol;
            selectedName = row.dataset.name;
            selectedStockName.textContent = selectedName;
            selectedStockSymbol.textContent = selectedSymbol;

            step2Card.classList.remove('hidden');
            step3Card.classList.add('hidden');
        });

        getStrategyBtn.addEventListener('click', function() {
            strategyLoader.classList.remove('hidden');
            step3Card.classList.remove('hidden');
            strategyResult.innerHTML = '';
            getStrategyBtn.disabled = true;

            const horizon = document.getElementById('investment-horizon').value;
            const payload = {
                symbol: selectedSymbol,
                horizon: horizon
            };

            fetch(`{% url 'trading:investment_strategy' %}?action=get_strategy`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    renderStrategy(data.strategy);
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error getting strategy:', error);
                alert('전략 분석 중 오류가 발생했습니다.');
            })
            .finally(() => {
                strategyLoader.classList.add('hidden');
                getStrategyBtn.disabled = false;
            });
        });

        // --- Helper Functions ---
        function renderStockList(stocks) {
            stockListTableBody.innerHTML = '';
            if (stocks.length === 0) {
                stockListTableBody.innerHTML = '<tr><td colspan="3">분석 결과 투자에 적합한 종목을 찾지 못했습니다.</td></tr>';
                return;
            }
            stocks.forEach(stock => {
                const row = document.createElement('tr');
                row.classList.add('stock-row');
                row.dataset.symbol = stock.symbol;
                row.dataset.name = stock.stock_name;
                row.innerHTML = `
                    <td>${stock.stock_name}</td>
                    <td>${stock.symbol}</td>
                    <td>${parseInt(stock.last_price).toLocaleString()} 원</td>
                `;
                stockListTableBody.appendChild(row);
            });
        }

        function renderStrategy(result) {
            strategyResult.innerHTML = `
                <h4>${selectedName} 최종 투자 전략</h4>
                <ul style="list-style-type: none; padding-left: 0;">
                    <li><strong>추천 매수 수량:</strong> ${result.buy_quantity > 0 ? result.buy_quantity + ' 주' : '예산 부족 또는 분석 실패'}</li>
                    <li><strong>목표가:</strong> ${result.target_price.toLocaleString()} 원</li>
                    <li><strong>손절매가:</strong> ${result.stop_loss_price.toLocaleString()} 원</li>
                </ul>
                <p style="font-size: 0.8em; color: #666;">* 본 분석은 AI를 기반으로 한 참고 자료이며, 투자에 대한 최종 책임은 투자자 본인에게 있습니다.</p>
            `;
        }
    });
    </script>
</body>
</html>
