<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Trading Dashboard{% endblock %}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .header { background-color: #fff; padding: 1em 2em; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; color: #1a2c5b; }
        nav { display: flex; gap: 1.5em; }
        nav a { text-decoration: none; color: #34495e; font-weight: 500; padding: 0.5em 0; border-bottom: 2px solid transparent; transition: border-color 0.3s; }
        nav a.active, nav a:hover { color: #2980b9; border-bottom-color: #2980b9; }
        .container { padding: 2em; max-width: 1200px; margin: 0 auto; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2em; }
        .card { background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 2em; }
        h2 { color: #1a2c5b; border-bottom: 2px solid #eef; padding-bottom: 0.5em; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 0.8em; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f7f7f7; font-weight: 600; }
        td.number, th.number { text-align: right; }
        .pl-positive { color: #c0392b; } /* Red for profit in Korea */
        .pl-negative { color: #2980b9; } /* Blue for loss in Korea */
        .messages { padding: 1em; margin-bottom: 1em; border-radius: 4px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { color: #c0392b; font-weight: bold; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        button:hover { background-color: #2980b9; }
        /* Add other common styles from dashboard.html here */
    </style>
    {% block extra_styles %}{% endblock %}
</head>
<body>
    {% load humanize %}
    <header class="header">
        <h1>종합 트레이딩 대시보드</h1>
        <nav>
            <a href="{% url 'trading:dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">대시보드</a>
            <a href="{% url 'trading:portfolio' %}" class="{% if request.resolver_match.url_name == 'portfolio' %}active{% endif %}">포트폴리오</a>
            <a href="{% url 'trading:orders' %}" class="{% if request.resolver_match.url_name == 'orders' %}active{% endif %}">주문 내역</a>
            <a href="{% url 'trading:system_management' %}" class="{% if request.resolver_match.url_name == 'system_management' %}active{% endif %}">시스템 관리</a>
        </nav>
        <div>
            <strong>총 자산:</strong> <span id="grand-total-assets">...</span> KRW
        </div>
    </header>

    <div class="container">
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    {% block extra_scripts %}{% endblock %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find the first active trading account to connect to.
        // In a multi-account setup, a more sophisticated selection mechanism would be needed.
        const firstAccount = "{{ request.user.tradingaccount_set.first.id }}";

        if (!firstAccount) {
            console.log("No active trading account found for WebSocket connection.");
            return;
        }

        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const wsPath = wsScheme + '://' + window.location.host + `/ws/trade/${firstAccount}/`;

        console.log("Connecting to WebSocket:", wsPath);
        const socket = new WebSocket(wsPath);

        socket.onopen = function(e) {
            console.log("WebSocket connection established.");
            // Example: subscribe to a specific stock's price updates
            // socket.send(JSON.stringify({'type': 'subscribe_stock', 'symbol': '005930'}));
        };

        socket.onclose = function(e) {
            console.error('WebSocket connection closed unexpectedly. Code:', e.code, 'Reason:', e.reason);
            // Optional: Implement reconnection logic here
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("WebSocket message received:", data);

            // Message router
            switch (data.type) {
                case 'system_message':
                    handleSystemMessage(data);
                    break;
                case 'trade_update':
                    handleTradeUpdate(data);
                    break;
                case 'stock_price_update':
                    handlePriceUpdate(data);
                    break;
                case 'account_refresh_required':
                case 'portfolio_refresh_required':
                    // A simple way to update is to reload the page.
                    // A more advanced implementation would update the DOM directly.
                    console.log("Refresh required. Reloading page for fresh data...");
                    location.reload();
                    break;
                default:
                    console.warn("Unhandled message type:", data.type);
            }
        };

        socket.onerror = function(err) {
            console.error('WebSocket error:', err);
        };

        // --- Message Handlers ---
        // These are placeholder functions. Specific pages will override or extend them.
        function handleSystemMessage(data) {
            console.log("System Message:", data.message);
            // Example: display a toast notification
        }

        function handleTradeUpdate(data) {
            console.log("Trade Update:", data.log);
            // This will be implemented in orders.html
        }

        function handlePriceUpdate(data) {
            console.log("Price Update:", data.symbol, data.price);
            // This will be implemented in portfolio.html and dashboard.html
        }

        // Make the socket object globally accessible if needed, or pass it to other functions
        window.tradingSocket = socket;
    });
    </script>
</body>
</html>
